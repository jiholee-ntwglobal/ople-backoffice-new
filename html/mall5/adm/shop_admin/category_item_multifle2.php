<?
$sub_menu = "400210";
include_once("./_common.php");

auth_check($auth[$sub_menu], "r");

function category_item_insert2($ca_arr,$it_id_arr){

	if(is_array($ca_arr) && is_array($it_id_arr)){
		$n=0;
		foreach($it_id_arr as $it_id){
			foreach($ca_arr as $cate){
				//$qry .= (($qry) ? ", ":" values ")."('".$cate."', '".$it_id."') ";
				$duplicate_info = sql_fetch("select count(*) as cnt from yc4_category_item where ca_id='$cate' and it_id='$it_id'");

				if($duplicate_info['cnt'] < 1){
					//echo "insert into yc4_category_item (ca_id,it_id) values ('".$cate."', '".$it_id."')".PHP_EOL;
					sql_query("insert into yc4_category_item (ca_id,it_id) values ('".$cate."', '".$it_id."')");
					$n++;
				}
			}
		}

		return $n;
	}

}


$g4['title'] = "다중 상품분류 변환";

include_once ($g4['path']."/head.sub.php");

//include_once ($g4['admin_path']."/admin.head.php");

if($_POST['mode']){

	include 'category_item_lib.php';

	$it_id_arr = array();

	if(is_array($_POST['it_id'])){
		$it_id_arr = $_POST['it_id'];
	} else {
		array_push($it_id_arr,$_POST['it_id']);
	}

	$new_cate_arr = array();

	if(is_array($_POST['new_cate'])){
		$new_cate_arr = $_POST['new_cate'];
	} else {
		array_push($new_cate_arr,$_POST['new_cate']);
	}




	$insert_cnt = category_item_insert2($new_cate_arr ,$it_id_arr);

	alert("카테고리 상품 등록이 완료되었습니다.(".$insert_cnt."건)","./category_item_multifle2.php?old_cate=$_POST[old_cate]&page=$_POST[page]");
}

## 기존 카테고리 selectbox 처리 시작 ##

$old_cate_rs = sql_query("select ca_id,ca_name from yc4_category order by ca_id asc");

while($data = sql_fetch_array($old_cate_rs)){

	$blank = strlen($data['ca_id']) > 2 ? '&nbsp;&nbsp;' : '';

	$selected = $data['ca_id'] === $_GET['old_cate'] ? 'selected' : '';

	$old_cate_options .= "<option value='$data[ca_id]' $selected>$blank $data[ca_name]</option>";
}

## 기존 카테고리 selectbox 처리 끝 ##


## 신규 카테고리 selectbox 처리 시작 ##

$old_cate_rs = sql_query("select ca_id,ca_name from yc4_category_new order by ca_id asc");
$third_cate = array('10','11','13','19','20','21','22','23','24','25','26','30','31','32','33','40','41','42','51','52');
$n=0;
while($data = sql_fetch_array($old_cate_rs)){

	$blank = str_repeat('&nbsp;&nbsp;', (strlen($data['ca_id'])/2)-1);

	switch(strlen($data['ca_id'])){
		case '2': $style = "style='background-color:red;color:white;font-weight:bold;'"; $blank = '&nbsp;&nbsp;'; $title_flag = true; break;
		case '4': $style = "style='color:blue;font-weight:bold;'";  $blank = '&nbsp;&nbsp;&nbsp;&nbsp;'; $title_flag = (in_array(substr($data['ca_id'],0,2),$third_cate))? true : false; break;
		default : $style = ''; $blank = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'; $title_flag = false; break;
	}

	if($title_flag){
		for($j=0;$j<$n%3;$j++){
			$new_cate_contents .= "<td></td>";
		}
		if($n%3!=2)	$new_cate_contents .= "</tr>";
		$new_cate_contents .= "<tr>";

	} else {
		if($n%3==0)	$new_cate_contents .= "<tr>";
	}

	$new_cate_contents .= "<td>$blank<input type='checkbox' name='new_cate[]' value='$data[ca_id]'><span $style>$blank $data[ca_name]</span>";

	if($title_flag){
		$new_cate_contents .= "<td></td><td></td></tr>";
	} else {
		if($n%3==2)	$new_cate_contents .= "</tr>";
	}


	$n++;
	if($title_flag){
		$n=0;
	}
}

## 신규 카테고리 selectbox 처리 끝 ##
/*
$it_code_where = " i.it_id in ('1407155215', '1357616209', '1357616210', '1407396665', '1399072864', '1388447874', '1362530710', '1376089950', '1298680266', '1399072763', '1307718873', '1402040574', '1407155843', '1399072113', '1374711880', '1349762625', '1370640835', '1373605724', '1402037863', '1398908436', '1398908273', '1398908786', '1410943064', '1374100569', '1399076931', '1399077173', '1351890962', '1241158838', '1378249591', '1351889737', '1351889953', '1327699985', '1327699365', '1376090167', '1369338559', '1410950064', '1232078201', '1351887466', '1351889168', '1351889582', '1400018090', '1353297929', '1373856692', '1374706936', '1274819675', '1398117034', '1313246264', '1368482192', '1368482805', '1351891153', '1407142501', '1368480832', '1336080295', '1374112299', '1382340045', '1332515223', '1399077432', '1327536271', '1374639958', '1407143516', '1407144106', '1319647613', '1274819013', '1399070368', '1389680061', '1367013409', '1326845156', '1240791394', '1268695005', '1388384434', '1398308435', '1377748187', '1398308074', '1373927451', '1355719567', '1389397879', '1319023996', '1362529531', '1347258571', '1374097864', '1376595939', '1398459518', '1406150854', '1316699463', '1208549398', '1372659948', '1370640619', '1407152027', '1407151821', '1407151258', '1398116200', '1327426324', '1203048291', '1395789512', '1349814105', '1365806352', '1351288820', '1368511785', '1327535896', '1319036210', '1361919725', '1399073144', '1337170984', '1388385559', '1342132637', '1407145525', '1398116628', '1397196043', '1378921936', '1374641546', '1154647596', '1326751649', '1408687304', '1274819520', '1351891287', '1336073191', '1392160674', '1367307390', '1407160630', '1306248387', '1395791546', '1355718544', '1367529143', '1412910226', '1363734847', '1344883064', '1307716780', '1399073035', '1413181971', '1408688719', '1374643100', '1380921719', '1394526360', '1378250024', '1389681566', '1378926396', '1357616208', '1355552953', '1226487643', '1399076606', '1283543189', '1368420009', '1367013731', '1399356911', '1330609102', '1372746841', '1400016915', '1407101511', '1327428273', '1177021016', '1327693799', '1213737981', '1321360081', '1408688237', '1351890288', '1410960064', '1407153744', '1399076870', '1352845380', '1401834240', '1366245620', '1400017088', '1336049197', '1306064651', '1410941064', '1325634910', '1331217239', '1353368598', '1353370014', '1395789422', '1352931102', '1378249932', '1268948171', '1308866098', '1289948621', '1327590465', '1327275538', '1327276416', '1313597083', '1413182229', '1219049772', '1203055959', '1312233322', '1258765339', '1368481306', '1368482618', '1368480378', '1368479954', '1368482336', '1370548991', '1367014154', '1371846414', '1399077684', '1239767193', '1267140717', '1322660713', '1267142668', '1368506814', '1376347388', '1241145802', '1331211484', '1327423437', '1241222500', '1331211116', '1388384596', '1410944064', '1398459673', '1367312027', '1332280692', '1336080014', '1407162932', '1407163818', '1283848783', '1214385799', '1274735693', '1398119090', '1355529752', '1407145430', '1324165819', '1385076893', '1378240223', '1330609760', '1397196178', '1313787973', '1184277355', '1320778325', '1204666960', '1344891488', '1374633060', '1407134805', '1407134442', '1389396515', '1400014877', '1407835675', '1337227574', '1313252888', '1201487256', '1364261883', '1268948337', '1273541395', '1228386019', '1221811580', '1328221443', '1228393570', '1221811740', '1347407764', '1368482880', '1368588830', '1367388493', '1340749725', '1203055188', '1317337403', '1365803095', '1274405723', '1398120113', '1351295491', '1409728953', '1413182405', '1307720180', '1413182334', '1413182118', '1314696632', '1370585884', '1370640362', '1344882588', '1368504127', '1399078532', '1361925593', '1355986704', '1331325107', '1342132426', '1368505902', '1308865203', '1330614286', '1239679362', '1398119149', '1326843883', '1326844638', '1374636741', '1317334875', '1305924507', '1214863660', '1214862709', '1213738980', '1193706995', '1327672434', '1329684949', '1374112080', '1307717564', '1341963235', '1351056272', '1376600162', '1366673649', '1389815774', '1349828115', '1351055641', '1361925870', '1410959064', '1368738788', '1392161005', '1355536067', '1336490537', '1390955493', '1407112335', '1407113207', '1331224399', '1260428559', '1313786202', '1228772263', '1374115809', '1313247894', '1351237190', '1389758134', '1175033680', '1408689719', '1336077268', '1389734747', '1221544887', '1407153242', '1368503352', '1409728203', '1409733624', '1374120337', '1307312197', '1320764585', '1330553045', '1241222485', '1383068756', '1339762557', '1337030784', '1336143896', '1407195517', '1355986216', '1407155300', '1305714646', '1314781940', '1225752627', '1400014512', '1388444895', '1397195626', '1397195377', '1397195300', '1397195128', '1397195010', '1342050249', '1397195218', '1369332828', '1407100224', '1378164493', '1365806820', '1407165014', '1373605191', '1222421288', '1394527459', '1374645659', '1313577185', '1337815860', '1305749276', '1268694327', '1331219924', '1368507146', '1399072646', '1398841715', '1331216866', '1336490292', '1350354157', '1213748505', '1369347505', '1397195718', '1352931871', '1389397775', '1394526308', '1335277113', '1203032764', '1328223959', '1328224776', '1337815862', '1339662626', '1370578803', '1412151006', '1368740042', '1359956564', '1374122897', '1372789857', '1388444239', '1382382751', '1410945064', '1382382752', '1410947064', '1410946064', '1351294160', '1410942064', '1374646146', '1382330791', '1339652626', '1206220977', '1319032447', '1409729426', '1327677748', '1329684593', '1368741406', '1388445130', '1330125920', '1208753281', '1410940064', '1350542027', '1363733107', '1350541434', '1203836041', '1349829691', '1389639917', '1410948064', '1410949064', '1368737722', '1394518392', '1368589995', '1200377604', '1350546828', '1399356658', '1389639760', '1200377319', '1382505453', '1343345948', '1360005246', '1200377177', '1369332350', '1406225920', '1349217908', '1313575971', '1364264929', '1389757839', '1317334085', '1241224260', '1398836676', '1207350144', '1386568586', '1206218957', '1308926904', '1337025284', '1341931551', '1336146836', '1359964259', '1349829519', '1382507466', '1394558749', '1389637443', '1332518908', '1328222365', '1382400555', '1298046788', '1372745462', '1391026211', '1380834469', '1219214139', '1363823846', '1349829974', '1398462259', '1301416791', '1398462327', '1398462523', '1398462632', '1398462669', '1219385156', '1410954064', '1214601042', '1378240068', '1388445221', '1341930515', '1373604750', '1389684068', '1386571005', '1330552603', '1399078426', '1389817665', '1409729286', '1407115211', '1407115408', '1407115035', '1407115310', '1408686985', '1412669448', '1408686722', '1388442168', '1410953064', '1409735624', '1385077468', '1370423600', '1410958064', '1410957064', '1366672664', '1410956064', '1410955064', '1410952064', '1410951064', '1342129134', '1357616207', '1341961268', '1366676242', '1392161250', '1412149006', '1367012336', '1365632023', '1349826598', '1349826894', '1365630971', '1341336960', '1366672731', '1409734624', '1374700988', '1327430820', '1327430567', '1327421530', '1327675372', '1319031961', '1361926685', '1386567658', '1398836913', '1374639194', '1305040142', '1378158344', '1385101355', '1342128895', '1342127539', '1368823628', '1342130096', '1385101544', '1336089386', '1385100813', '1388177196', '1222380694', '1222380619', '1222380973', '1325636271', '1222380806', '1222380502', '1330612485', '1394562536', '1354757582', '1367992030', '1394518586', '1367125502', '1368820601', '1337815861', '1366671944', '1204858089', '1349829849', '1342129492', '1407163304', '1399354855', '1395791715', '1412150006', '1370642263', '1353545000', '1353544511', '1407834675', '1333119380', '1395791266', '1369352115', '1372745066', '1407177219', '1342046519', '1409729510', '1413182443', '1413182473', '1366670701', '1346453693', '1336049712', '1342127705', '1407183234', '1406004006', '1389678733', '1395790112', '1342018200', '1409729224', '1409729127', '1361928480', '1350539106', '1355991697', '1378157540', '1342129355', '1342047119', '1342130365', '1407112509', '1363731799', '1409729624', '1413182512', '1413166967', '1389681735', '1374703738', '1398459447', '1398459385', '1398459309', '1398459182', '1406002347', '1361929320', '1410939064', '1391018692', '1409731624', '1406003033', '1407164407', '1409728592', '1354758376', '1409732624', '1413167441', '1361929707', '1409730624', '1361936663', '1369354320', '1376682739', '1388444447', '1377750525', '1377750649', '1407164204', '1407163619', '1342531916'
) ";*/

$total_rs = sql_query("select count(i.it_id) as cnt from yc4_item i where   i.it_use = 1 and i.ca_id not in( 'h0' ,'u0')");
$total_info = sql_fetch_array($total_rs);

if($_GET['old_cate']) $cate_where = " AND (left(i.ca_id,".strlen($_GET['old_cate']).")='$_GET[old_cate]'  or left(i.ca_id2,".strlen($_GET['old_cate']).")='$_GET[old_cate]' or left(i.ca_id3,".strlen($_GET['old_cate']).")='$_GET[old_cate]' or left(i.ca_id4,".strlen($_GET['old_cate']).")='$_GET[old_cate]' or left(i.ca_id5,".strlen($_GET['old_cate']).")='$_GET[old_cate]') ";

if($_GET['it_name']) $cate_where .= " AND i.it_name like '%$_GET[it_name]%' ";
if($_GET['it_id']) $cate_where .= " AND i.it_id = '$_GET[it_id]' ";
if($_GET['it_maker']) $cate_where .= " AND i.it_maker like '%$_GET[it_maker]%' ";

$cnt_rs = sql_query("select count(i.it_id) as cnt from yc4_item i  where  i.it_use = 1 and i.ca_id not in( 'h0' ,'u0') $cate_where");
$cnt_info = sql_fetch_array($cnt_rs);

$page = $_GET['page'] ? $_GET['page'] : 1;

$it_cnt = $cnt_info['cnt'];
$rows = $config['cf_page_rows'];
$total_page  = ceil($it_cnt / $rows);  // 전체 페이지 계산
if ($page == "") { $page = 1; } // 페이지가 없으면 첫 페이지 (1 페이지)
$from_record = ($page - 1) * $rows; // 시작 열을 구함


$it_qry = sql_query($a="
	SELECT i.it_id, i.it_name, i.it_maker, i.it_amount, i.it_discontinued
	FROM yc4_item i
	where  i.it_use = 1 and i.ca_id not in( 'h0' ,'u0') $cate_where limit $from_record,$rows
");

while($row = sql_fetch_array($it_qry)){

	$list .= "<tr>
			<td><input type='checkbox' name='it_id[]' value='".$row['it_id']."'/></td>
			<td>".$row['it_maker']."</td>
			<td>".$row['it_id']."</td>
			<td>".$row['it_name']."</td>
			<td align='right'>".number_format($row['it_amount'])."</td>
			<td align='center'>".($row['it_discontinued'] == 1 ? "o":"x" )."</td>
		</tr>";

}


?>

<a href="category_item_multifle2.php">전체 상품</a>(<?php echo $total_info['cnt']; ?>)&nbsp;&nbsp;현재 카테고리 상품(<?php echo number_format($it_cnt); ?>)<br/><br/>
<form name="frm">
<input type="hidden" name="mode" value="convert"/>
<input type="hidden" name="page" value="<?php echo $page; ?>"/>
<table width='100%'>
	<tr>
		<td width="55%" align="left">
		<select name="old_cate" onchange="location.href='category_item_multifle2.php?old_cate='+this.value">
			<option value="">기존 카테고리 선택</option>
			<?php echo $old_cate_options; ?>
		</select>&nbsp;<input type="text" name="it_id" value="<?php echo stripcslashes($_GET['it_id']);?>" placeholder="상품코드 입력" style="width:90px;">&nbsp;<input type="text" name="it_name" value="<?php echo stripcslashes($_GET['it_name']);?>" placeholder="상품명 입력" style="width:90px;">&nbsp;<input type="text" name="it_maker" value="<?php echo stripcslashes($_GET['it_maker']);?>" placeholder="제조사 입력" style="width:90px;">&nbsp;<input type="button" value="검색" onclick="seach_it_name()"/>
		</td>
		<td width="45%" align="right">
		</td>
	</tr>
</table>
<table width="100%">
	<tr>
		<td width="60%" valign="top">

		<table width='100%'>
			<thead>
				<th>
					<input type="checkbox" class='chk_all'/>
				</th>
				<th>제조사</th>
				<th>it_id</th>
				<th>상품명</th>
				<th>가격</th>
				<th>단종여부</th>
			</thead>
			<tbody>

				<?=$list;?>
			</tbody>
		</table>
		</td>
		<td width="40%" valign="top">
		<div style="overflow-y:scroll;height:700px;">
		<table width='100%' border='1'>
		<?php echo $new_cate_contents; ?>
		</table>
		</div>
		<table width='100%'>
			<tr>
				<td align="center"><input type="button" style="width:200px;height:60px;" value="적용" onclick="save_item_category()"/></td>
			</tr>
		</table>
		</td>
	</tr>
</table>
<?
$gparam = $_GET;
unset($gparam['page']);

echo get_paging($config[cf_write_pages], $page, $total_page, "$_SERVER[PHP_SELF]?".http_build_query($gparam)."&page=");
?>
</form>

<script>
$(document).ready(function(){
	$(".chk_all").click(function(){
		if($(this).is(":checked")){
			$(":checkbox[name^=it_id]").attr("checked","checked");
		} else {
			$(":checkbox[name^=it_id]").attr("checked",false);
		}
	});
});

function seach_it_name(){
	frm.page.value=1;
	location.href = "category_item_multifle2.php?" + $("form[name=frm]").serialize();
}

function save_item_category(){

	var chk_num = 0;

	$(":checkbox[name^=it_id]").each(function(){
		if($(this).is(":checked")) chk_num++;
	});
	if(chk_num < 1){
		alert("적용할 상품을 선택해주세요.");
		return false;
	}

	var chk_flag = false;

	$("input[name^=new_cate]").each(function(){
		if($(this).is(":checked")){
			chk_flag = true;
			return;
		}

	});

	if(!chk_flag){
		alert("적용할 신규 카테고리를 체크해주세요.");
		return false;
	}

	$("form[name=frm]").attr("method","POST");

	$("form[name=frm]").submit();
}
</script>

<?
include_once ($g4['admin_path']."/admin.tail.php");
?>